<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  
  <title><![CDATA[源代码]]></title>
  <subtitle><![CDATA[敏捷, 持续交付, 微服务, 重构, 大数据, Java]]></subtitle>
  <link href="/atom.xml" rel="self"/>
  <link href="http://wenhao.github.io//"/>
  <updated>2015-10-26T09:08:46.000Z</updated>
  <id>http://wenhao.github.io//</id>
  
  <author>
    <name><![CDATA[文浩]]></name>
    <email><![CDATA[wenhao@126.com]]></email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title><![CDATA[基于GeoHash+Redis实现LBS附近地点搜索]]></title>
    <link href="http://wenhao.github.io/2015/10/21/%E5%9F%BA%E4%BA%8EGeoHash+Redis%E5%AE%9E%E7%8E%B0LBS%E9%99%84%E8%BF%91%E5%9C%B0%E7%82%B9%E6%90%9C%E7%B4%A2/"/>
    <id>http://wenhao.github.io/2015/10/21/基于GeoHash+Redis实现LBS附近地点搜索/</id>
    <published>2015-10-21T07:55:27.000Z</published>
    <updated>2015-10-26T09:08:46.000Z</updated>
    <content type="html"><![CDATA[<p><img src="/img/geohash.png" alt="GeoHash"></p>
<h3 id="需求">需求</h3><p>随着移动业务的不断创新，基于位置服务的需求逐渐增多。比如美团搜索附近的美食，嘀嘀打车搜搜附近的司机等。支撑这一业务最主要的就是LBS(基于位置的服务)，特别是嘀嘀打车的业务尤为突出，司机与乘客不断更新的坐标地址，从一大堆无关的坐标地址内找出一定范围内所有的司机，这无疑对服务器承载力带来巨大的挑战。</p>
<p>先比较一下不同的解决方案。最后讲解一下如何使用52位的GeoHash集成Redis实现此需求。</p>
<h3 id="解决方案">解决方案</h3><ol>
<li>物理计算，正对某个中心点，计算所有周边点，再根据搜索范围刷选。</li>
<li>基于MySQL，可选择物理计算/GeoHash/MySQL空间索引。</li>
<li>基于MongoDB，依赖MongoDB的空间搜索算法搜索。</li>
<li>自行开发搜索算法并存入Redis。</li>
</ol>
<a id="more"></a>
<h3 id="方案解析">方案解析</h3><h5 id="物理计算">物理计算</h5><p>在我们第一次遇到这类问题，头脑里面最先浮现的解决方案，但是我们的潜意思告诉我们这肯定是不行的。如果搜索的受众量很大，光是计算距离就要消耗大量的时间。</p>
<h5 id="基于MySQL">基于MySQL</h5><p>存入MySQL实现上有三种方式：</p>
<ol>
<li><p>根据纬度和精度每增加0.01度增加1000m为算法，检索出候选坐标，再根据搜索范围刷选。距离搜索3公里以内所有目标，伪代码：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">double</span> kilometer = <span class="number">3.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">double</span> precision = <span class="number">0.01</span> * kilometer;</span><br><span class="line"></span><br><span class="line"><span class="comment">//SQL 限定条件 </span></span><br><span class="line">SELECT * FROM driver_coordinate</span><br><span class="line">WHERE latitude &gt; latitude - precision &amp;&amp; </span><br><span class="line">      latitude &lt; latitude + precision &amp;&amp;</span><br><span class="line">      longitude &gt; longitude - precisionRadius &amp;&amp; </span><br><span class="line">      longitude &lt; longitude + precisionRadius;</span><br></pre></td></tr></table></figure>
</li>
<li><p>给每一个坐标计算一个<a href="https://en.wikipedia.org/wiki/Geohash" target="_blank" rel="external">GeoHash</a>值，业界大部分的使用的是基于Base32编码的12位GeoHash字符串。但是这样精度不太容易控制。我们将要讨论的是52位的整形值来表示GeoHash。52位的GeoHash最小能精确到0.6米，足够满足绝大部分需求(52位GeoHash算法见下文)。</p>
</li>
<li><p>MySQL空间存储，MySQL本省就支持空间搜索。</p>
 <figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GLength<span class="list">(<span class="keyword">LineStringFromWKB</span><span class="list">(<span class="keyword">LineString</span><span class="list">(<span class="keyword">point1</span>, point2)</span>)</span>)</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>但是由于MySQL的限制，查询效率低，可伸缩性较差。</p>
<h5 id="基于MongoDB">基于MongoDB</h5><p>MonggoDB原生也支持地理位置索引，支持位置查询及排序。</p>
<p>命令如:</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">db</span><span class="class">.runCommand</span>(&#123; <span class="attribute">geoNear</span>: <span class="string">"places"</span>, <span class="attribute">near</span>: [<span class="number">30.545162</span>, <span class="number">104.062018</span>], <span class="attribute">num</span>:<span class="number">1000</span> &#125;)</span><br></pre></td></tr></table></figure>
<p>MongoDB支持地理位置查询，可伸缩性较好，配置集群简单，集成方便快，成本最低。3.0版本之后增加了Collection锁，性能大大提升。业界也有不少公司在使用，比如美团、街旁、全球最大的LBS应用<a href="https://foursquare.com/" target="_blank" rel="external">Foursquare</a>用的MongoDB。</p>
<h5 id="自行开发搜索算法并存入Redis">自行开发搜索算法并存入Redis</h5><p>自行开发算法精度与扩展方式容易控制，对第三方没有依赖方便升级与替换。</p>
<h3 id="具体实现">具体实现</h3><ol>
<li><p>坐标转换成52bit二进制编码值。</p>
<ul>
<li>52bit精度在0.6m足够满足搜索范围需求。</li>
<li><p>算法，根据经纬度计算GeoHash二进制编码：</p>
<ul>
<li>首先将纬度范围(-90, 90)平分成两个区间(-90, 0)、(0, 90)， 如果目标纬度位于前一个区间，则编码为0，否则编码为1。由于39.92324属于(0, 90)，所以取编码为1。然后再将(0, 90)分成 (0, 45), (45, 90)两个区间，而39.92324位于(0, 45)，所以编码为0。以此类推，直到精度符合要求为止，得到纬度编码为1011 1000 1100 0111 1001。</li>
<li>经度也用同样的算法，对(-180, 180)依次细分，得到116.3906的编码为1101 0010 1100 0100 0100。</li>
<li>接下来将经度和纬度的编码合并，奇数位是纬度，偶数位是经度，得到编码 11100 11101 00100 01111 00000 01101 01011 00001。   </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.github.wenhao.geohash;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.wenhao.geohash.domain.Coordinate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GeoHash</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_PRECISION = <span class="number">52</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> FIRST_BIT_FLAGGED = <span class="number">0x8000000000000L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> bits = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span> significantBits = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> Coordinate coordinate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">GeoHash</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GeoHash <span class="title">fromCoordinate</span><span class="params">(<span class="keyword">double</span> latitude, <span class="keyword">double</span> longitude)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fromCoordinate(latitude, longitude, MAX_PRECISION);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GeoHash <span class="title">fromCoordinate</span><span class="params">(<span class="keyword">double</span> latitude, <span class="keyword">double</span> longitude, <span class="keyword">int</span> precision)</span> </span>&#123;</span><br><span class="line">        GeoHash geoHash = <span class="keyword">new</span> GeoHash();</span><br><span class="line">        geoHash.coordinate = <span class="keyword">new</span> Coordinate(latitude, longitude);</span><br><span class="line">        <span class="keyword">boolean</span> isEvenBit = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">double</span>[] latitudeRange = &#123;-<span class="number">90</span>, <span class="number">90</span>&#125;;</span><br><span class="line">        <span class="keyword">double</span>[] longitudeRange = &#123;-<span class="number">180</span>, <span class="number">180</span>&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (geoHash.significantBits &lt; precision) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isEvenBit) &#123;</span><br><span class="line">                divideRangeEncode(geoHash, longitude, longitudeRange);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                divideRangeEncode(geoHash, latitude, latitudeRange);</span><br><span class="line">            &#125;</span><br><span class="line">            isEvenBit = !isEvenBit;</span><br><span class="line">        &#125;</span><br><span class="line">        geoHash.bits &lt;&lt;= (MAX_PRECISION - precision);</span><br><span class="line">        <span class="keyword">return</span> geoHash;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GeoHash <span class="title">fromLong</span><span class="params">(<span class="keyword">long</span> longValue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fromLong(longValue, MAX_PRECISION);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GeoHash <span class="title">fromLong</span><span class="params">(<span class="keyword">long</span> longValue, <span class="keyword">int</span> significantBits)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">double</span>[] latitudeRange = &#123;-<span class="number">90.0</span>, <span class="number">90.0</span>&#125;;</span><br><span class="line">        <span class="keyword">double</span>[] longitudeRange = &#123;-<span class="number">180.0</span>, <span class="number">180.0</span>&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> isEvenBit = <span class="keyword">true</span>;</span><br><span class="line">        GeoHash geoHash = <span class="keyword">new</span> GeoHash();</span><br><span class="line"></span><br><span class="line">        String binaryString = Long.toBinaryString(longValue);</span><br><span class="line">        <span class="keyword">while</span> (binaryString.length() &lt; MAX_PRECISION) &#123;</span><br><span class="line">            binaryString = <span class="string">"0"</span> + binaryString;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; significantBits; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isEvenBit) &#123;</span><br><span class="line">                divideRangeDecode(geoHash, longitudeRange, binaryString.charAt(j) != <span class="string">'0'</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                divideRangeDecode(geoHash, latitudeRange, binaryString.charAt(j) != <span class="string">'0'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            isEvenBit = !isEvenBit;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">double</span> latitude = (latitudeRange[<span class="number">0</span>] + latitudeRange[<span class="number">1</span>]) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">double</span> longitude = (longitudeRange[<span class="number">0</span>] + longitudeRange[<span class="number">1</span>]) / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        geoHash.coordinate = <span class="keyword">new</span> Coordinate(latitude, longitude);</span><br><span class="line">        geoHash.bits &lt;&lt;= (MAX_PRECISION - geoHash.significantBits);</span><br><span class="line">        <span class="keyword">return</span> geoHash;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">distance</span><span class="params">(<span class="keyword">double</span> latitude, <span class="keyword">double</span> longitude)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">double</span> startLatitude = <span class="keyword">this</span>.coordinate.getLatitude();</span><br><span class="line">        <span class="keyword">double</span> startLongitude = <span class="keyword">this</span>.coordinate.getLongitude();</span><br><span class="line">        <span class="keyword">double</span> diffLongitudes = toRadians(abs(longitude - startLongitude));</span><br><span class="line">        <span class="keyword">double</span> diffLatitudes = toRadians(abs(latitude - startLatitude));</span><br><span class="line">        <span class="keyword">double</span> slat = toRadians(startLatitude);</span><br><span class="line">        <span class="keyword">double</span> flat = toRadians(latitude);</span><br><span class="line">        <span class="keyword">double</span> factor = sin(diffLatitudes / <span class="number">2</span>) * sin(diffLatitudes / <span class="number">2</span>) + cos(slat) * cos(flat) * sin(diffLongitudes / <span class="number">2</span>)</span><br><span class="line">                * sin(diffLongitudes / <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">double</span> angularDistance = <span class="number">2</span> * atan2(sqrt(factor), sqrt(<span class="number">1</span> - factor));</span><br><span class="line">        <span class="keyword">return</span> EARTH_RADIUS * angularDistance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;GeoHash&gt; <span class="title">getAdjacent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        GeoHash northern = getNorthernNeighbour();</span><br><span class="line">        GeoHash eastern = getEasternNeighbour();</span><br><span class="line">        GeoHash southern = getSouthernNeighbour();</span><br><span class="line">        GeoHash western = getWesternNeighbour();</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(northern, northern.getEasternNeighbour(), eastern, southern.getEasternNeighbour(),</span><br><span class="line">                southern, southern.getWesternNeighbour(), western, northern.getWesternNeighbour());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> GeoHash <span class="title">getNorthernNeighbour</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span>[] latitudeBits = getRightAlignedLatitudeBits();</span><br><span class="line">        <span class="keyword">long</span>[] longitudeBits = getRightAlignedLongitudeBits();</span><br><span class="line">        latitudeBits[<span class="number">0</span>] += <span class="number">1</span>;</span><br><span class="line">        latitudeBits[<span class="number">0</span>] = maskLastNBits(latitudeBits[<span class="number">0</span>], latitudeBits[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">return</span> recombineLatLonBitsToHash(latitudeBits, longitudeBits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> GeoHash <span class="title">getSouthernNeighbour</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span>[] latitudeBits = getRightAlignedLatitudeBits();</span><br><span class="line">        <span class="keyword">long</span>[] longitudeBits = getRightAlignedLongitudeBits();</span><br><span class="line">        latitudeBits[<span class="number">0</span>] -= <span class="number">1</span>;</span><br><span class="line">        latitudeBits[<span class="number">0</span>] = maskLastNBits(latitudeBits[<span class="number">0</span>], latitudeBits[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">return</span> recombineLatLonBitsToHash(latitudeBits, longitudeBits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> GeoHash <span class="title">getEasternNeighbour</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span>[] latitudeBits = getRightAlignedLatitudeBits();</span><br><span class="line">        <span class="keyword">long</span>[] longitudeBits = getRightAlignedLongitudeBits();</span><br><span class="line">        longitudeBits[<span class="number">0</span>] += <span class="number">1</span>;</span><br><span class="line">        longitudeBits[<span class="number">0</span>] = maskLastNBits(longitudeBits[<span class="number">0</span>], longitudeBits[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">return</span> recombineLatLonBitsToHash(latitudeBits, longitudeBits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> GeoHash <span class="title">getWesternNeighbour</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span>[] latitudeBits = getRightAlignedLatitudeBits();</span><br><span class="line">        <span class="keyword">long</span>[] longitudeBits = getRightAlignedLongitudeBits();</span><br><span class="line">        longitudeBits[<span class="number">0</span>] -= <span class="number">1</span>;</span><br><span class="line">        longitudeBits[<span class="number">0</span>] = maskLastNBits(longitudeBits[<span class="number">0</span>], longitudeBits[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">return</span> recombineLatLonBitsToHash(latitudeBits, longitudeBits);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> GeoHash <span class="title">recombineLatLonBitsToHash</span><span class="params">(<span class="keyword">long</span>[] latBits, <span class="keyword">long</span>[] lonBits)</span> </span>&#123;</span><br><span class="line">        GeoHash geoHash = <span class="keyword">new</span> GeoHash();</span><br><span class="line">        <span class="keyword">boolean</span> isEvenBit = <span class="keyword">false</span>;</span><br><span class="line">        latBits[<span class="number">0</span>] &lt;&lt;= (MAX_PRECISION - latBits[<span class="number">1</span>]);</span><br><span class="line">        lonBits[<span class="number">0</span>] &lt;&lt;= (MAX_PRECISION - lonBits[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">double</span>[] latitudeRange = &#123;-<span class="number">90.0</span>, <span class="number">90.0</span>&#125;;</span><br><span class="line">        <span class="keyword">double</span>[] longitudeRange = &#123;-<span class="number">180.0</span>, <span class="number">180.0</span>&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; latBits[<span class="number">1</span>] + lonBits[<span class="number">1</span>]; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isEvenBit) &#123;</span><br><span class="line">                divideRangeDecode(geoHash, latitudeRange, (latBits[<span class="number">0</span>] &amp; FIRST_BIT_FLAGGED) == FIRST_BIT_FLAGGED);</span><br><span class="line">                latBits[<span class="number">0</span>] &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                divideRangeDecode(geoHash, longitudeRange, (lonBits[<span class="number">0</span>] &amp; FIRST_BIT_FLAGGED) == FIRST_BIT_FLAGGED);</span><br><span class="line">                lonBits[<span class="number">0</span>] &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            isEvenBit = !isEvenBit;</span><br><span class="line">        &#125;</span><br><span class="line">        geoHash.bits &lt;&lt;= (MAX_PRECISION - geoHash.significantBits);</span><br><span class="line">        geoHash.coordinate = getCenterCoordinate(latitudeRange, longitudeRange);</span><br><span class="line">        <span class="keyword">return</span> geoHash;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span>[] getRightAlignedLatitudeBits() &#123;</span><br><span class="line">        <span class="keyword">long</span> copyOfBits = bits &lt;&lt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">long</span> value = extractEverySecondBit(copyOfBits, getNumberOfLatLonBits()[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">long</span>[]&#123;value, getNumberOfLatLonBits()[<span class="number">0</span>]&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span>[] getRightAlignedLongitudeBits() &#123;</span><br><span class="line">        <span class="keyword">long</span> copyOfBits = bits;</span><br><span class="line">        <span class="keyword">long</span> value = extractEverySecondBit(copyOfBits, getNumberOfLatLonBits()[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">long</span>[]&#123;value, getNumberOfLatLonBits()[<span class="number">1</span>]&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">extractEverySecondBit</span><span class="params">(<span class="keyword">long</span> copyOfBits, <span class="keyword">int</span> numberOfBits)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> value = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numberOfBits; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((copyOfBits &amp; FIRST_BIT_FLAGGED) == FIRST_BIT_FLAGGED) &#123;</span><br><span class="line">                value |= <span class="number">0x1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            value &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">            copyOfBits &lt;&lt;= <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        value &gt;&gt;&gt;= <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Coordinate <span class="title">getCenterCoordinate</span><span class="params">(<span class="keyword">double</span>[] latitudeRange, <span class="keyword">double</span>[] longitudeRange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">double</span> minLon = Math.min(longitudeRange[<span class="number">0</span>], longitudeRange[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">double</span> maxLon = Math.max(longitudeRange[<span class="number">0</span>], longitudeRange[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">double</span> minLat = Math.min(latitudeRange[<span class="number">0</span>], latitudeRange[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">double</span> maxLat = Math.max(latitudeRange[<span class="number">0</span>], latitudeRange[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">double</span> centerLatitude = (minLat + maxLat) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">double</span> centerLongitude = (minLon + maxLon) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Coordinate(centerLatitude, centerLongitude);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] getNumberOfLatLonBits() &#123;</span><br><span class="line">        <span class="keyword">if</span> (significantBits % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;significantBits / <span class="number">2</span>, significantBits / <span class="number">2</span>&#125;;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;significantBits / <span class="number">2</span>, significantBits / <span class="number">2</span> + <span class="number">1</span>&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">maskLastNBits</span><span class="params">(<span class="keyword">long</span> value, <span class="keyword">long</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> mask = <span class="number">0xffffffffffffffffl</span>;</span><br><span class="line">        mask &gt;&gt;&gt;= (MAX_PRECISION - n);</span><br><span class="line">        <span class="keyword">return</span> value &amp; mask;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">divideRangeEncode</span><span class="params">(GeoHash geoHash, <span class="keyword">double</span> value, <span class="keyword">double</span>[] range)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">double</span> mid = (range[<span class="number">0</span>] + range[<span class="number">1</span>]) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (value &gt;= mid) &#123;</span><br><span class="line">            geoHash.addOnBitToEnd();</span><br><span class="line">            range[<span class="number">0</span>] = mid;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            geoHash.addOffBitToEnd();</span><br><span class="line">            range[<span class="number">1</span>] = mid;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">divideRangeDecode</span><span class="params">(GeoHash geoHash, <span class="keyword">double</span>[] range, <span class="keyword">boolean</span> b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">double</span> mid = (range[<span class="number">0</span>] + range[<span class="number">1</span>]) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (b) &#123;</span><br><span class="line">            geoHash.addOnBitToEnd();</span><br><span class="line">            range[<span class="number">0</span>] = mid;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            geoHash.addOffBitToEnd();</span><br><span class="line">            range[<span class="number">1</span>] = mid;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addOnBitToEnd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        significantBits++;</span><br><span class="line">        bits &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">        bits = bits | <span class="number">0x1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addOffBitToEnd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        significantBits++;</span><br><span class="line">        bits &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">toLong</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bits;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Coordinate <span class="title">coordinate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> coordinate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (significantBits % <span class="number">5</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> String.format(<span class="string">"bits: %s"</span>, Long.toBinaryString(bits));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> String.format(<span class="string">"bits: %s"</span>, Long.toBinaryString(bits));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>支持坐标转换成GeoHash与Long型值反转回坐标，转换会有误差，误差分米级能够接受。</p>
</li>
</ul>
</li>
<li><p>估算搜索范围起始值。</p>
<ul>
<li><p>算法, 如果用52位来表示一个坐标, 那么总共有: 2^26 * 2^26 = 2^52 个框:</p>
<ul>
<li>地球半径：radius = 6372797.560856m</li>
<li>每个框的夹角：angle = 1 / 2^26 (2的26次方)</li>
<li>每个框在地球表面的长度: length = 2 <em> π </em> radius * angle</li>
<li>52bit:0.59m, 50bit:1.19m……,30bit:1221.97m, 28bit:2443.94m, 26bit:4887.87m, 24bit: 9775.75m……</li>
</ul>
</li>
</ul>
</li>
<li><p>给出查询的中心坐标并计算其GeoHash值(52bit)。</p>
</li>
<li><p>计算中心坐标相邻的8个坐标(中心坐标在两个框边界会有误差，此规避误差)。</p>
</li>
<li><p>加上中心坐标共9个52bit的坐标值，针对每个坐标值参照搜索范围值算出区域值[MIN, MAX]。</p>
<ul>
<li><p>算法：MIN为坐标的搜索指定位起始长度后补零；MAX为坐标的搜索指定位终止长度后+1再补零。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.github.wenhao.geohash;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.math.BigDecimal.ROUND_HALF_UP;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.github.wenhao.geohash.GeoHash.MAX_PRECISION;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GeoSearch</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> BigDecimal EARTH_RADIUS = <span class="keyword">new</span> BigDecimal(<span class="number">6372797.560856</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;BigDecimal, Integer&gt; PRECISION_MAP;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        PRECISION_MAP = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> angle = <span class="number">1</span>; angle &lt;= MAX_PRECISION / <span class="number">2</span>; angle++) &#123;</span><br><span class="line">            BigDecimal bigDecimal = <span class="keyword">new</span> BigDecimal(<span class="number">2</span>)</span><br><span class="line">                    .multiply(<span class="keyword">new</span> BigDecimal(Math.PI))</span><br><span class="line">                    .multiply(EARTH_RADIUS)</span><br><span class="line">                    .divide(<span class="keyword">new</span> BigDecimal(<span class="number">2</span>).pow(angle), ROUND_HALF_UP);</span><br><span class="line">            PRECISION_MAP.put(bigDecimal, <span class="number">2</span> * angle);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span>[] search(<span class="keyword">double</span> latitude, <span class="keyword">double</span> longitude, <span class="keyword">double</span> startRage, <span class="keyword">double</span> endRange) &#123;</span><br><span class="line">        GeoHash geoHash = GeoHash.fromCoordinate(latitude, longitude);</span><br><span class="line">        <span class="keyword">long</span> longValue = geoHash.toLong();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">long</span>[]&#123;getStartRange(longValue, startRage), getEndRange(longValue, endRange)&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getStartRange</span><span class="params">(<span class="keyword">long</span> longValue, <span class="keyword">double</span> startRage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> length = MAX_PRECISION;</span><br><span class="line">        Optional&lt;BigDecimal&gt; smallerKey = PRECISION_MAP.keySet()</span><br><span class="line">                .stream()</span><br><span class="line">                .sorted(Collections.reverseOrder())</span><br><span class="line">                .filter(bigDecimal -&gt; bigDecimal.compareTo(BigDecimal.valueOf(startRage)) == -<span class="number">1</span>)</span><br><span class="line">                .findFirst();</span><br><span class="line">        <span class="keyword">if</span> (smallerKey.isPresent()) &#123;</span><br><span class="line">            length = PRECISION_MAP.get(smallerKey.get());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> desiredMinPrecision = longValue &gt;&gt;&gt; (MAX_PRECISION - length);</span><br><span class="line">        desiredMinPrecision &lt;&lt;= (MAX_PRECISION - length);</span><br><span class="line">        <span class="keyword">return</span> desiredMinPrecision;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getEndRange</span><span class="params">(<span class="keyword">long</span> longValue, <span class="keyword">double</span> endRange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> length = <span class="number">0</span>;</span><br><span class="line">        Optional&lt;BigDecimal&gt; biggerKey = PRECISION_MAP.keySet()</span><br><span class="line">                .stream()</span><br><span class="line">                .sorted()</span><br><span class="line">                .filter(bigDecimal -&gt; bigDecimal.compareTo(BigDecimal.valueOf(endRange)) == <span class="number">1</span>)</span><br><span class="line">                .findFirst();</span><br><span class="line">        <span class="keyword">if</span> (biggerKey.isPresent()) &#123;</span><br><span class="line">            length = PRECISION_MAP.get(biggerKey.get());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> desiredMaxPrecision = (longValue &gt;&gt;&gt; (MAX_PRECISION - length)) + <span class="number">1</span>;</span><br><span class="line">        desiredMaxPrecision &lt;&lt;= (MAX_PRECISION - length);</span><br><span class="line">        <span class="keyword">return</span> desiredMaxPrecision;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>例如搜索3000m~5000m的目标，最小3000m介于精度28bit：2443.94m~26bit：4887.87m之间故最小精度取右28bit右全补零。最大5000m介于26bit：4887.87m~24bit：9775.75m之间取右24bit的值加1后右全补零。</p>
</li>
</ul>
</li>
<li><p>使用Redis命令ZRANGEBYSCORE key MIN MAX WITHSCORES查找。</p>
</li>
<li><p>避免误差按照距离公式在将所有结果过滤一次(GeoHash反坐标再计算距离)。</p>
</li>
</ol>
]]></content>
    <summary type="html">
    <![CDATA[<p><img src="/img/geohash.png" alt="GeoHash"></p>
<h3 id="需求">需求</h3><p>随着移动业务的不断创新，基于位置服务的需求逐渐增多。比如美团搜索附近的美食，嘀嘀打车搜搜附近的司机等。支撑这一业务最主要的就是LBS(基于位置的服务)，特别是嘀嘀打车的业务尤为突出，司机与乘客不断更新的坐标地址，从一大堆无关的坐标地址内找出一定范围内所有的司机，这无疑对服务器承载力带来巨大的挑战。</p>
<p>先比较一下不同的解决方案。最后讲解一下如何使用52位的GeoHash集成Redis实现此需求。</p>
<h3 id="解决方案">解决方案</h3><ol>
<li>物理计算，正对某个中心点，计算所有周边点，再根据搜索范围刷选。</li>
<li>基于MySQL，可选择物理计算/GeoHash/MySQL空间索引。</li>
<li>基于MongoDB，依赖MongoDB的空间搜索算法搜索。</li>
<li>自行开发搜索算法并存入Redis。</li>
</ol>]]>
    
    </summary>
    
      <category term="geohash" scheme="http://wenhao.github.io/tags/geohash/"/>
    
      <category term="lbs" scheme="http://wenhao.github.io/tags/lbs/"/>
    
      <category term="geohash" scheme="http://wenhao.github.io/categories/geohash/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[spring和kafka集成]]></title>
    <link href="http://wenhao.github.io/2015/10/02/spring%E5%92%8Ckafka%E9%9B%86%E6%88%90/"/>
    <id>http://wenhao.github.io/2015/10/02/spring和kafka集成/</id>
    <published>2015-10-02T02:27:35.000Z</published>
    <updated>2015-10-02T02:43:42.000Z</updated>
    <content type="html"><![CDATA[<p><img src="/img/kafka-logo.png" alt="kafka"></p>
<h3 id="创建项目">创建项目</h3><ul>
<li>创建项目文件夹spring-kafka</li>
<li>生成项目结构<code>gradle init --type java-library</code></li>
</ul>
<a id="more"></a>
<h3 id="添加依赖build-gradle">添加依赖build.gradle</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        mavenCentral()</span><br><span class="line">        maven &#123; url <span class="string">'https://repo.spring.io/simple/ext-release-local'</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath(<span class="string">"org.springframework.boot:spring-boot-gradle-plugin:1.2.6.RELEASE"</span>)</span><br><span class="line">        classpath <span class="string">'org.apache.maven:maven-artifact:2.2.1'</span></span><br><span class="line">        classpath <span class="string">'org.apache.avro:avro-compiler:1.7.3'</span></span><br><span class="line">        classpath <span class="string">"org.apache.avro:avro-gradle-plugin:1.7.2"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'java'</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'idea'</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'maven'</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'spring-boot'</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'avro-gradle-plugin'</span></span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">    mavenCentral()</span><br><span class="line">    jcenter()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">defaultTasks <span class="string">'clean'</span>, <span class="string">'build'</span></span><br><span class="line"></span><br><span class="line">ext &#123;</span><br><span class="line">    avroTaskGroup = <span class="string">"Avro"</span></span><br><span class="line">    avroSource = <span class="string">"schemas"</span></span><br><span class="line">    avroDest = <span class="string">"target/generated-avro-sources/main/java"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile <span class="string">'org.springframework.boot:spring-boot-starter-web'</span></span><br><span class="line">    compile(<span class="string">'org.springframework.integration:spring-integration-kafka:1.2.1.RELEASE'</span>) &#123;</span><br><span class="line">        exclude <span class="string">module:</span> <span class="string">'log4j'</span></span><br><span class="line">        exclude <span class="string">module:</span> <span class="string">'jms'</span></span><br><span class="line">        exclude <span class="string">module:</span> <span class="string">'jmxtools'</span></span><br><span class="line">        exclude <span class="string">module:</span> <span class="string">'jmxri'</span></span><br><span class="line">    &#125;</span><br><span class="line">    compile(<span class="string">"log4j:log4j:1.2.15"</span>) &#123;</span><br><span class="line">        exclude <span class="string">module:</span> <span class="string">'mail'</span></span><br><span class="line">        exclude <span class="string">module:</span> <span class="string">'jms'</span></span><br><span class="line">        exclude <span class="string">module:</span> <span class="string">'jmx'</span></span><br><span class="line">        exclude <span class="string">module:</span> <span class="string">'jmxtools'</span></span><br><span class="line">        exclude <span class="string">module:</span> <span class="string">'jmxri'</span></span><br><span class="line">    &#125;</span><br><span class="line">    compile <span class="string">"commons-logging:commons-logging:1.1.1"</span></span><br><span class="line">    compile(<span class="string">'org.apache.avro:avro:1.7.7'</span>) &#123;</span><br><span class="line">        exclude <span class="string">module:</span> <span class="string">'slf4j-log4j12'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">compileAvro.group = avroTaskGroup</span><br><span class="line">compileAvro.description = <span class="string">"Generates Java code from avro schema"</span></span><br><span class="line">compileAvro.source = avroSource</span><br><span class="line">compileAvro.destinationDir = file(avroDest)</span><br><span class="line"></span><br><span class="line">task cleanAvro(<span class="string">type:</span> Delete) &#123;</span><br><span class="line">    group = avroTaskGroup</span><br><span class="line">    description = <span class="string">"deletes generated avro code"</span></span><br><span class="line">    delete avroDest</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">compileJava.dependsOn compileAvro</span><br><span class="line"></span><br><span class="line">sourceSets &#123;</span><br><span class="line">    main &#123;</span><br><span class="line">        java &#123;</span><br><span class="line">            srcDir avroDest</span><br><span class="line">        &#125;</span><br><span class="line">        resources &#123;</span><br><span class="line">            srcDir avroSource</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mainClassName = <span class="string">'org.github.wenhao.kafka.Application'</span></span><br></pre></td></tr></table></figure>
<h3 id="spring-boot启动类">spring-boot启动类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.github.wenhao.kafka;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用Avro序列化，创建schema">使用Avro序列化，创建schema</h3><p>在项目根目录schemas文件夹下创建<strong>user.avdl</strong>, <a href="http://avro.apache.org/docs/current/idl.html" target="_blank" rel="external">Apache AVDL文档</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@namespace</span>(<span class="string">"org.github.wenhao.kafka.avro"</span>)</span><br><span class="line">protocol UserAvroProtocol&#123;</span><br><span class="line">    record UserAvro &#123;</span><br><span class="line">        string name;</span><br><span class="line">        <span class="keyword">int</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="配置kafka-outbound">配置kafka-outbound</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">beans</span> <span class="attribute">xmlns</span>=<span class="value">"http://www.springframework.org/schema/beans"</span></span><br><span class="line">       <span class="attribute">xmlns:xsi</span>=<span class="value">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line">       <span class="attribute">xmlns:int</span>=<span class="value">"http://www.springframework.org/schema/integration"</span></span><br><span class="line">       <span class="attribute">xmlns:int-kafka</span>=<span class="value">"http://www.springframework.org/schema/integration/kafka"</span></span><br><span class="line">       <span class="attribute">xmlns:task</span>=<span class="value">"http://www.springframework.org/schema/task"</span></span><br><span class="line">       <span class="attribute">xsi:schemaLocation</span>=<span class="value">"http://www.springframework.org/schema/integration/kafka http://www.springframework.org/schema/integration/kafka/spring-integration-kafka.xsd</span><br><span class="line">truetruehttp://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration.xsd</span><br><span class="line">truetruehttp://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="line">truetruehttp://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">int:channel</span> <span class="attribute">id</span>=<span class="value">"inputToKafka"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">int:queue</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">int:channel</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">int:poller</span> <span class="attribute">default</span>=<span class="value">"true"</span> <span class="attribute">id</span>=<span class="value">"default"</span> <span class="attribute">fixed-rate</span>=<span class="value">"3"</span> <span class="attribute">time-unit</span>=<span class="value">"MILLISECONDS"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">int-kafka:outbound-channel-adapter</span> <span class="attribute">id</span>=<span class="value">"kafkaOutboundChannelAdapter"</span></span><br><span class="line">                                        <span class="attribute">auto-startup</span>=<span class="value">"true"</span></span><br><span class="line">                                        <span class="attribute">kafka-producer-context-ref</span>=<span class="value">"kafkaProducerContext"</span></span><br><span class="line">                                        <span class="attribute">channel</span>=<span class="value">"inputToKafka"</span></span><br><span class="line">                                        <span class="attribute">topic</span>=<span class="value">"test"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">int-kafka:outbound-channel-adapter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">task:executor</span> <span class="attribute">id</span>=<span class="value">"taskExecutor"</span> <span class="attribute">pool-size</span>=<span class="value">"5"</span> <span class="attribute">keep-alive</span>=<span class="value">"120"</span> <span class="attribute">queue-capacity</span>=<span class="value">"500"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"producerProperties"</span> <span class="attribute">class</span>=<span class="value">"org.springframework.beans.factory.config.PropertiesFactoryBean"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"properties"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">props</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">prop</span> <span class="attribute">key</span>=<span class="value">"topic.metadata.refresh.interval.ms"</span>&gt;</span>3600000<span class="tag">&lt;/<span class="title">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">prop</span> <span class="attribute">key</span>=<span class="value">"message.send.max.retries"</span>&gt;</span>5<span class="tag">&lt;/<span class="title">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="title">prop</span> <span class="attribute">key</span>=<span class="value">"send.buffer.bytes"</span>&gt;</span>5242880<span class="tag">&lt;/<span class="title">prop</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="title">props</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"kafkaReflectionEncoder"</span> <span class="attribute">class</span>=<span class="value">"org.springframework.integration.kafka.serializer.avro.AvroReflectDatumBackedKafkaEncoder"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">type</span>=<span class="value">"java.lang.Class"</span> <span class="attribute">value</span>=<span class="value">"java.lang.String"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"kafkaSpecificEncoder"</span> <span class="attribute">class</span>=<span class="value">"org.springframework.integration.kafka.serializer.avro.AvroSpecificDatumBackedKafkaEncoder"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">value</span>=<span class="value">"org.github.wenhao.kafka.avro.UserAvro"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">int-kafka:producer-context</span> <span class="attribute">id</span>=<span class="value">"kafkaProducerContext"</span> <span class="attribute">producer-properties</span>=<span class="value">"producerProperties"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">int-kafka:producer-configurations</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">int-kafka:producer-configuration</span> <span class="attribute">broker-list</span>=<span class="value">"localhost:9092"</span></span><br><span class="line">                                              <span class="attribute">key-class-type</span>=<span class="value">"java.lang.String"</span></span><br><span class="line">                                              <span class="attribute">value-class-type</span>=<span class="value">"org.github.wenhao.kafka.avro.UserAvro"</span></span><br><span class="line">                                              <span class="attribute">topic</span>=<span class="value">"test"</span></span><br><span class="line">                                              <span class="attribute">key-encoder</span>=<span class="value">"kafkaReflectionEncoder"</span></span><br><span class="line">                                              <span class="attribute">value-encoder</span>=<span class="value">"kafkaSpecificEncoder"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">int-kafka:producer-configurations</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">int-kafka:producer-context</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="配置kafka-inbound">配置kafka-inbound</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">beans</span> <span class="attribute">xmlns</span>=<span class="value">"http://www.springframework.org/schema/beans"</span></span><br><span class="line">       <span class="attribute">xmlns:xsi</span>=<span class="value">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line">       <span class="attribute">xmlns:int</span>=<span class="value">"http://www.springframework.org/schema/integration"</span></span><br><span class="line">       <span class="attribute">xmlns:int-kafka</span>=<span class="value">"http://www.springframework.org/schema/integration/kafka"</span></span><br><span class="line">       <span class="attribute">xsi:schemaLocation</span>=<span class="value">" http://www.springframework.org/schema/integration/kafka http://www.springframework.org/schema/integration/kafka/spring-integration-kafka.xsd</span><br><span class="line">truetruehttp://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration.xsd</span><br><span class="line">truetruehttp://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">int:channel</span> <span class="attribute">id</span>=<span class="value">"inputFromKafka"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">int:queue</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">int:channel</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"kafkaReflectionDecoder"</span> <span class="attribute">class</span>=<span class="value">"org.springframework.integration.kafka.serializer.avro.AvroReflectDatumBackedKafkaDecoder"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">type</span>=<span class="value">"java.lang.Class"</span> <span class="attribute">value</span>=<span class="value">"java.lang.String"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"kafkaSpecificDecoder"</span> <span class="attribute">class</span>=<span class="value">"org.springframework.integration.kafka.serializer.avro.AvroSpecificDatumBackedKafkaDecoder"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">value</span>=<span class="value">"org.github.wenhao.kafka.avro.UserAvro"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">int-kafka:zookeeper-connect</span> <span class="attribute">id</span>=<span class="value">"zookeeperConnect"</span> <span class="attribute">zk-connect</span>=<span class="value">"localhost:2181"</span> <span class="attribute">zk-connection-timeout</span>=<span class="value">"6000"</span></span><br><span class="line">                                 <span class="attribute">zk-session-timeout</span>=<span class="value">"6000"</span></span><br><span class="line">                                 <span class="attribute">zk-sync-time</span>=<span class="value">"2000"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"kafkaConfiguration"</span> <span class="attribute">class</span>=<span class="value">"org.springframework.integration.kafka.core.ZookeeperConfiguration"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">ref</span>=<span class="value">"zookeeperConnect"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"connectionFactory"</span> <span class="attribute">class</span>=<span class="value">"org.springframework.integration.kafka.core.DefaultConnectionFactory"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">ref</span>=<span class="value">"kafkaConfiguration"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">int-kafka:message-driven-channel-adapter</span></span><br><span class="line">            <span class="attribute">id</span>=<span class="value">"adapter"</span></span><br><span class="line">            <span class="attribute">channel</span>=<span class="value">"inputFromKafka"</span></span><br><span class="line">            <span class="attribute">connection-factory</span>=<span class="value">"connectionFactory"</span></span><br><span class="line">            <span class="attribute">key-decoder</span>=<span class="value">"kafkaReflectionDecoder"</span></span><br><span class="line">            <span class="attribute">payload-decoder</span>=<span class="value">"kafkaSpecificDecoder"</span></span><br><span class="line">            <span class="attribute">max-fetch</span>=<span class="value">"100"</span></span><br><span class="line">            <span class="attribute">auto-startup</span>=<span class="value">"true"</span></span><br><span class="line">            <span class="attribute">topics</span>=<span class="value">"test"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="注入kafka-outbound">注入kafka-outbound</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.github.wenhao.kafka.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ImportResource;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Configuration</span></span><br><span class="line"><span class="annotation">@ImportResource</span>(<span class="string">"classpath:/kafka-outbound.xml"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KafkaOutboundConfiguraiton</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="注入kafka-inbound">注入kafka-inbound</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.github.wenhao.kafka.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ImportResource;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Configuration</span></span><br><span class="line"><span class="annotation">@ImportResource</span>(<span class="string">"classpath:/kafka-inbound.xml"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KafkaInboundConfiguration</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="值对象">值对象</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.github.wenhao.kafka.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="消息发送服务">消息发送服务</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.github.wenhao.kafka.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.github.wenhao.kafka.avro.UserAvro;</span><br><span class="line"><span class="keyword">import</span> org.github.wenhao.kafka.domain.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.integration.kafka.support.KafkaHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.integration.support.MessageBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.MessageChannel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Resource</span>(name = <span class="string">"inputToKafka"</span>)</span><br><span class="line">    <span class="keyword">private</span> MessageChannel inputToKafka;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">produce</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        UserAvro specificUser = UserAvro.newBuilder()</span><br><span class="line">                .setName(user.getName())</span><br><span class="line">                .setAge(user.getAge())</span><br><span class="line">                .build();</span><br><span class="line">        Message&lt;UserAvro&gt; message = MessageBuilder.withPayload(specificUser)</span><br><span class="line">                .setHeader(KafkaHeaders.MESSAGE_KEY, <span class="string">"user"</span>)</span><br><span class="line">                .setHeader(KafkaHeaders.TOPIC, <span class="string">"test"</span>)</span><br><span class="line">                .build();</span><br><span class="line">        inputToKafka.send(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="消息接受服务">消息接受服务</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.github.wenhao.kafka.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.github.wenhao.kafka.avro.UserAvro;</span><br><span class="line"><span class="keyword">import</span> org.github.wenhao.kafka.domain.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.integration.channel.QueueChannel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.messaging.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerService</span> </span>&#123;</span><br><span class="line">    <span class="annotation">@Resource</span>(name = <span class="string">"inputFromKafka"</span>)</span><br><span class="line">    <span class="keyword">private</span> QueueChannel inputFromKafka;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">receive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Message&lt;UserAvro&gt; message = (Message&lt;UserAvro&gt;) inputFromKafka.receive();</span><br><span class="line">        UserAvro userAvro = message.getPayload();</span><br><span class="line"></span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setName(userAvro.getName().toString());</span><br><span class="line">        user.setAge(userAvro.getAge());</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建API">创建API</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.github.wenhao.kafka.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.web.bind.annotation.RequestMethod.POST;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.github.wenhao.kafka.domain.User;</span><br><span class="line"><span class="keyword">import</span> org.github.wenhao.kafka.service.ConsumerService;</span><br><span class="line"><span class="keyword">import</span> org.github.wenhao.kafka.service.ProducerService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@RestController</span></span><br><span class="line"><span class="annotation">@RequestMapping</span>(value = <span class="string">"/producer"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerApi</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ProducerService producerService;</span><br><span class="line">    <span class="keyword">private</span> ConsumerService consumerService;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProducerApi</span><span class="params">(ProducerService producerService, ConsumerService consumerService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.producerService = producerService;</span><br><span class="line">        <span class="keyword">this</span>.consumerService = consumerService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@RequestMapping</span>(method = POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;User&gt; <span class="title">produce</span><span class="params">(@RequestBody User user)</span> </span>&#123;</span><br><span class="line">        producerService.produce(user);</span><br><span class="line">        User receive = consumerService.receive();</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(receive);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
    <summary type="html">
    <![CDATA[<p><img src="/img/kafka-logo.png" alt="kafka"></p>
<h3 id="创建项目">创建项目</h3><ul>
<li>创建项目文件夹spring-kafka</li>
<li>生成项目结构<code>gradle init --type java-library</code></li>
</ul>]]>
    
    </summary>
    
      <category term="kafka" scheme="http://wenhao.github.io/tags/kafka/"/>
    
      <category term="kafka" scheme="http://wenhao.github.io/categories/kafka/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[接口无益]]></title>
    <link href="http://wenhao.github.io/2015/07/09/%E6%8E%A5%E5%8F%A3%E6%97%A0%E7%9B%8A/"/>
    <id>http://wenhao.github.io/2015/07/09/接口无益/</id>
    <published>2015-07-09T09:36:47.000Z</published>
    <updated>2015-07-10T01:22:32.000Z</updated>
    <content type="html"><![CDATA[<p><strong>你认为接口怎么样？</strong></p>
<p><em>你的意识是Java或者C#的interface</em></p>
<p><strong>是的，接口是一个好的语言特性吗？</strong></p>
<p><em>当然，接口很好用！</em></p>
<p><strong>真的吗，呃。接口是什么？一个类吗？</strong></p>
<p><em>不是，和类不一样。</em></p>
<p><strong>怎么说？</strong></p>
<p><em>接口没有方法实现。</em></p>
<p><strong>这是一个接口吗？</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">MyInterface</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>这不是，这是一个抽象类。</em></p>
<a id="more"></a>
<p><strong>比起接口，有什么不同？</strong></p>
<p><em>好吧，抽象类可以有方法实现。</em></p>
<p><strong>对，但是这个没有，为什么它不是一个接口呢？</strong></p>
<p><em>好吧，一个抽象类可以包含非静态变量，而接口不能。</em></p>
<p><strong>对，但是这个也没有。再问，为什么它不是一个接口？</strong></p>
<p><em>因为它本来就不是。</em></p>
<p><strong>这不是一个令人满意的答案。如何区分它和接口呢？有什么是可以使用接口但是不能使用抽象类的呢？</strong></p>
<p><em>类可以继承其他类，但是不能同时实现你的这个抽象类。</em></p>
<p><strong>为什么不能？</strong></p>
<p><em>因为，在Java里，你不能同时继承多个类。</em></p>
<p><strong>为什么不能？</strong></p>
<p><em>因为Java编译器不允许你这样做。</em></p>
<p><strong>这太死板了。好吧，为什么不能实现那个抽象类而不是继承它呢？</strong></p>
<p><em>因为编译器只允许你实现一个抽象接口。</em></p>
<p><strong>这种规则太奇怪了。</strong></p>
<p><em>才不是，这很合情合理。编译器允许你实现多个接口但是只能让你继承一个类。</em></p>
<p><strong>为什么Java编译器允许你实现多个接口，但是不允许你继承多个类呢？</strong></p>
<p><em>因为类多重继承很危险。</em></p>
<p><strong>真的吗？怎么回事？</strong></p>
<p><em>因为多重继承会导致致命方块。</em></p>
<p><strong>天呐，听起来很可怕。什么是致命方块？</strong></p>
<p><em>当某个类继承其他两个类，这两个类就同时继承另外一个类。</em></p>
<p><strong>你的意思是：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D1</span> <span class="keyword">extends</span> <span class="title">B</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D2</span> <span class="keyword">extends</span> <span class="title">B</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">M</span> <span class="keyword">extends</span> <span class="title">D1</span>, <span class="title">D2</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p><em>对，这很糟糕！</em></p>
<p><strong>为什么这很糟糕？</strong></p>
<p><em>因为类B可能有实例变量！</em></p>
<p><strong>你的意思像这样？</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;<span class="keyword">private</span> <span class="keyword">int</span> i;&#125;</span><br></pre></td></tr></table></figure>
<p><em>对呀！这样的话某个M的实例会有多少个i变量呢？</em></p>
<p><strong>嗯，我明白了。由于D1和D2都有i变量，又因为M继承与D1和D2，这种情况下你也许期盼着M有两个不同的i变量。</strong></p>
<p><em>对！但是由于M也间接继承与B，B只有一个i变量，你也许只期望M只包含一个i变量。</em></p>
<p><strong>嗯，这种继承关系有点模糊不清。</strong></p>
<p><em>对！</em></p>
<p><strong>因此Java和C#不能有多重继承是因为可能造成致命方块问题？</strong></p>
<p><em>不是的，因为每个人都可能造成致命方块问题由于所有的类都是继承与Object类的。</em></p>
<p><strong>嗯，明白了。编译器作者不会把Object特殊处理吗？</strong></p>
<p><em>呃…他们不会。</em></p>
<p><strong>我有点好奇为什么呢？有其他编译器作者解决这个问题吗？</strong></p>
<p><em>当然有，C++允许你创建致命方块问题。</em></p>
<p><strong>对，我想Eiffel也可以。</strong></p>
<p><em>对了，天呐，我想Ruby有解决方法。</em></p>
<p><strong>是的，使用CLOS(common-lisp object system)—好吧，我们说致命方块问题几十年前就解决了并且不是致命的，也没有导致更坏的结果。</strong></p>
<p><em>呃。对，我猜你是对的。</em></p>
<p><strong>让我们回到我原来的问题上。为什么这不是一个接口？</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">MyInterface</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>因为它使用的关键字是class；而且这门语言也不允许你做多重继承。</em></p>
<p><strong>对。所以关键字interface的发明是为了避免多重继承。</strong></p>
<p><em>是的，可能是事实。</em></p>
<p><strong>为什么Java或者C#的作者不适用已知的解决方案解决多重继承呢？</strong></p>
<p><em>我不知道。</em></p>
<p><strong>我也不知道，但是我可以猜。</strong></p>
<p><em>你猜到了什么？</em></p>
<p><strong>懒惰。</strong></p>
<p><em>什么，懒惰？</em></p>
<p><strong>对，它们根本不想处理这个问题。因此创建了一个新的东西绕过这个问题。这个东西就是interface。</strong></p>
<p><em>你是说Java的作者创建interface是为了避免一些额外的工作量？</em></p>
<p><strong>除此之外，我不能解释这个问题。</strong></p>
<p><em>这有点太过鲁莽。我确信他们的意图肯定不只是这个。不管怎么样，有interface不会是什么坏事吧？我的意思是，它应该也没什么坏处吧？</em></p>
<p><strong>尝试问你自己这个问题：为什么某个类需要知道它实现某个接口？这种东西是不是应该隐藏起来呢？</strong></p>
<p><em>你的意思某个派生类应该知道这个并判断使用正确的关键字，extends或者implements，对吗？</em></p>
<p><strong>对！如果你把class改成接口，有多少派生类需要同时修改？</strong></p>
<p><em>都得改，至少在Java里面来说。在C#倒是解决了这个问题。</em></p>
<p><strong>确实是这样。关键字implements和extends确实是多余而且危险的。Java还不如C#和C++使用冒号。</strong></p>
<p><em>好，好吧，但是究竟什么时候需要使用多重继承呢？</em></p>
<p><strong>下列情况我会用：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Observer&gt; observers = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Observer o)</span> </span>&#123;</span><br><span class="line">        observers.add(o);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Observer o : observers)</span><br><span class="line">            o.update();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWidget</span> </span>&#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyObservableWidget</span> <span class="keyword">extends</span> <span class="title">MyWidget</span>, <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>哦，这是观察者模式！</em></p>
<p><strong>是的，这是观察者模式——完全正确。</strong></p>
<p><em>但是你不能编译因为你不能继承多个类。</em></p>
<p><strong>对，这就很悲剧。</strong></p>
<p><em>悲剧？但是为什么这样说呢？我的意思是你可以让MyWidget继承Subject类！</em></p>
<p><strong>但是我并不想MyWidget知道任何关于观察者的信息。我想保持其关注点分离。观察者与小部件的关注点分离。</strong></p>
<p><em>之后只需要在MyObservableWidget类实现register和notify方法。</em></p>
<p><strong>什么？在每个观察者里面重复这些代码？我不认同这种做法。</strong></p>
<p><em>在MyObservableWidget里持有Subject的引用把功能代理给Subject。</em></p>
<p><strong>什么？在每个观察者里面重复这些代理代码？如此愚蠢。如此拙劣。呸。</strong></p>
<p><em>好吧，你不得不在一个或多个观察者做这事。</em></p>
<p><strong>我知道。但是我讨厌这样做。</strong></p>
<p><em>呃，似乎也没办法避免。要么你违反关注点分离原则，要么重复部分代码。</em></p>
<p><strong>是的。这种情况下语言强迫我不得不这样做。</strong></p>
<p><em>是的，很不幸。</em></p>
<p><strong>到底是语言的什么特性导致这种糟糕的局面呢？</strong></p>
<p><em>关键字interface。</em></p>
<p><strong>所以说…?</strong></p>
<p><em>关键字interface没什么好处，接口无益。</em></p>
<hr>
<p>翻译自<a href="http://blog.cleancoder.com/uncle-bob/2015/01/08/InterfaceConsideredHarmful.html" target="_blank" rel="external">‘Interface’ Considered Harmful</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<p><strong>你认为接口怎么样？</strong></p>
<p><em>你的意识是Java或者C#的interface</em></p>
<p><strong>是的，接口是一个好的语言特性吗？</strong></p>
<p><em>当然，接口很好用！</em></p>
<p><strong>真的吗，呃。接口是什么？一个类吗？</strong></p>
<p><em>不是，和类不一样。</em></p>
<p><strong>怎么说？</strong></p>
<p><em>接口没有方法实现。</em></p>
<p><strong>这是一个接口吗？</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">MyInterface</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>这不是，这是一个抽象类。</em></p>]]>
    
    </summary>
    
      <category term="Robert C. Martin" scheme="http://wenhao.github.io/tags/Robert-C-Martin/"/>
    
      <category term="翻译" scheme="http://wenhao.github.io/tags/%E7%BF%BB%E8%AF%91/"/>
    
      <category term="翻译" scheme="http://wenhao.github.io/categories/%E7%BF%BB%E8%AF%91/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[小小单例模式]]></title>
    <link href="http://wenhao.github.io/2015/07/07/%E5%B0%8F%E5%B0%8F%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/"/>
    <id>http://wenhao.github.io/2015/07/07/小小单例模式/</id>
    <published>2015-07-07T13:40:29.000Z</published>
    <updated>2015-07-09T05:50:49.000Z</updated>
    <content type="html"><![CDATA[<p><img src="/img/singleton-pattern.png" alt="单例模式"></p>
<p><strong>你熟悉这段代码吗：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">X</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> X instance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">X</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> X <span class="title">instance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (instance == <span class="keyword">null</span>)</span><br><span class="line">      instance = <span class="keyword">new</span> X();</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// more methods...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>当然。这是GOF这本书里面提到的单例模式。但是我总是听到别人说我们不应该使用它。</em></p>
<p><strong>为什么我们不应该使用它？</strong></p>
<p><em>因为它使得我们的系统难以测试</em></p>
<p><strong>真的吗？为什么会那样呢？</strong></p>
<p><em>因为你不能模拟(mock)一个单例对象。</em></p>
<p><strong>不能吗？为什么不能？</strong></p>
<p><em>这样说吧，因为唯一能够访问私有变量的类只有单例对象自身，不暴露给外部就没办法模拟(mock)。</em></p>
<a id="more"></a>
<p><strong>你知道封装和测试的规则吗？</strong></p>
<p><em>嗯，不知道。规则是什么呢？</em></p>
<p><strong>测试胜过封装。</strong></p>
<p><em>这是什么意思呢？</em></p>
<p><strong>意思就是测试赢了封装。只是为了维持封装性的话，没有测试会被限制访问某个变量。</strong></p>
<p><em>你的意思是如果测试需要访问私有变量…</em></p>
<p><strong>…变量不应该是私有的。对。</strong></p>
<p><em>听起来好像不对。我的意思是，封装，呃，很重要！</em></p>
<p><strong>测试更为重要。</strong></p>
<p><em>等等。什么？</em></p>
<p><strong>如果代码不能够被测试，封装性好的代码又有什么好的呢？</strong></p>
<p><em>好，好吧，但是如果我们不得不测试单例对象呢。</em></p>
<p><strong>看如下代码。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">X</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> X instance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">X</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> X <span class="title">instance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (instance == <span class="keyword">null</span>)</span><br><span class="line">      instance = <span class="keyword">new</span> X();</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// methods.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestX</span> </span>&#123;</span><br><span class="line">  <span class="annotation">@Before</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    X.instance = <span class="keyword">new</span> XMock();   </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XMock</span> <span class="keyword">extends</span> <span class="title">X</span> </span>&#123;</span><br><span class="line">    <span class="comment">// overide methods</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>哦，你把实例变量变成“包”范围。</em></p>
<p><strong>对。</strong></p>
<p><em>这样的话你就可以模拟单例对象了。</em></p>
<p><strong>对。考虑一下代码：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">X</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> X instance = <span class="keyword">new</span> X();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">X</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// methods.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>等等！实例方法哪去了？</em></p>
<p><strong>我不需要实例方法。</strong></p>
<p><em>哦，这个实例变量是公共的。你可以直接使用它。</em></p>
<p><strong>对。</strong></p>
<p><em>但是…但是…其他人可能重写它？</em></p>
<p><strong>谁会做那事？</strong></p>
<p><em>我不知道。呃，某些坏人吧。</em></p>
<p><strong>你们团队有这种坏人吗？</strong></p>
<p><em>没有。但是。只是感觉这样做不太安全。</em></p>
<p><strong>这样，如果它是公共API的一部分，我同意你的观点。但是如果这段代码只会被我们项目用到那就另当别论了…</strong></p>
<p><em>我们应该信任我们团队成员？</em></p>
<p><strong>当然。</strong></p>
<p><em>这样更容易模拟(mock)，对吗？</em></p>
<p><strong>当然。</strong></p>
<p><em>如此的话我猜我们应用使用单例模式如果我们想用的话。</em></p>
<p><strong>当然。经管大多数情况下我不想。</strong></p>
<p><em>这一番讨论之后，你现在却想告诉我你不想使用单例模式？</em></p>
<p><strong>是这样，我想理解为什么不适用它更为重要。</strong></p>
<p><em>好吧，为什么你不适用单例模式？</em></p>
<p><strong>我有时候也用。特别是在做公共APIs的时候。</strong></p>
<p><em>你的意思是又是信任的问题？</em></p>
<p><strong>对。在公共API中如果我想确保只有一个实例被创建时，我就会使用单例模式。</strong></p>
<p><em>好吧，但是如果不是在做公共API的时候，但是你任然想只创建一个实例呢？</em></p>
<p><strong>这样的话，我就直接的创建一个。</strong></p>
<hr>
<p>翻译自<a href="http://blog.cleancoder.com/uncle-bob/2015/07/01/TheLittleSingleton.html" target="_blank" rel="external">The Little Singleton</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<p><img src="/img/singleton-pattern.png" alt="单例模式"></p>
<p><strong>你熟悉这段代码吗：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">X</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> X instance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">X</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> X <span class="title">instance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (instance == <span class="keyword">null</span>)</span><br><span class="line">      instance = <span class="keyword">new</span> X();</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// more methods...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>当然。这是GOF这本书里面提到的单例模式。但是我总是听到别人说我们不应该使用它。</em></p>
<p><strong>为什么我们不应该使用它？</strong></p>
<p><em>因为它使得我们的系统难以测试</em></p>
<p><strong>真的吗？为什么会那样呢？</strong></p>
<p><em>因为你不能模拟(mock)一个单例对象。</em></p>
<p><strong>不能吗？为什么不能？</strong></p>
<p><em>这样说吧，因为唯一能够访问私有变量的类只有单例对象自身，不暴露给外部就没办法模拟(mock)。</em></p>]]>
    
    </summary>
    
      <category term="Robert C. Martin" scheme="http://wenhao.github.io/tags/Robert-C-Martin/"/>
    
      <category term="设计模式" scheme="http://wenhao.github.io/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
      <category term="设计模式" scheme="http://wenhao.github.io/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[微服务利弊权衡]]></title>
    <link href="http://wenhao.github.io/2015/07/06/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%88%A9%E5%BC%8A%E6%9D%83%E8%A1%A1/"/>
    <id>http://wenhao.github.io/2015/07/06/微服务利弊权衡/</id>
    <published>2015-07-06T04:14:31.000Z</published>
    <updated>2015-07-20T10:04:36.000Z</updated>
    <content type="html"><![CDATA[<p><img src="/img/microservice.png" alt="微服务架构"></p>
<p>现在许多开发团队已经意识到<a href="http://martinfowler.com/articles/microservices.html" target="_blank" rel="external">微服务架构模式</a>会是解决大型单体应用架构所带来的问题的首选解决方案，但是某些团队也反应微服务架构会在某种程度上降低整个开发团队的开发效率。与任何其他架构模式一样，微服务架构也有其利弊之处，结合你特定的应用场景理解这些利弊之处能够帮助你做出更加明智的选择。</p>
<h4 id="微服务提供的好处…">微服务提供的好处…</h4><ul>
<li><a href="./#高度的模块边界化">高度的模块边界化</a>：微服务促进系统模块化，对大型团队尤其重要。</li>
<li><a href="./#独立部署">独立部署</a>：简单的服务部署更为容易因为它的依赖更少，并且服务是相对独立的，而且当某个服务出错时不太可能引起整个应用程序系统崩溃。</li>
<li><a href="./#技术多样性">技术多样性</a>：使用微服务你可以混用多种开发语言，开发框架和数据存储技术。</li>
</ul>
<h4 id="微服务引入的成本…">微服务引入的成本…</h4><ul>
<li><a href="./#分布式">分布式</a>：分布式系统开发难度大，因为远程调用速度慢且出错风险极高。</li>
<li><a href="./#最终一致性">最终一致性</a>：在分布式系统中管理强一致性问题更加困难，这意味着每个服务都必须关注系统的最终一致性问题。</li>
<li><a href="./#运维复杂性">运维复杂性</a>：你需要一个较为成熟的维护团队来管理诸多的微服务，处理日常的微服务更新及频繁部署等问题。</li>
</ul>
<a id="more"></a>
<p><a href="./#总结">总结</a></p>
<h3 id="高度的模块边界化">高度的模块边界化</h3><p>第一个好处是微服务高度的模块边界化低耦合。这是一个重要的好处同时这本身也是一个很奇怪的论断，为什么微服务就应该有高度的模块边界化特性，而单体应用不能有此特性呢，理论上讲没有任何理由这样说。</p>
<p>此处我说的高度的模块边界化是什么意思呢？软件内部某些部分相互依赖高度耦合，好的解决方法是把它们解耦分成不同模块，我相信大家都会认同这种做法。你希望你分解的模块可以在你需要修改系统的某一部分时，只需要理解系统很小的一部分就可以更改，而且要能够很容易就能定位到需要修改的地方。在任何程序中，好的模块化模型都是非常有用的，而且随着软件系统的复杂度渐增其重要程度可能成指数级放大，更为重要的是当开发团队持续壮大的时候。</p>
<p>微服务的提倡者很快就提出了<a href="http://www.thoughtworks.com/insights/blog/demystifying-conways-law" target="_blank" rel="external">康韦法则</a>，这个概念的意思是软件设计的架构，实际上反应了公司的组织与沟通架构。对于大型团队，尤其是团队分布在不同的地区时，在决定系统架构时，要考虑到小团队内部的沟通会比在大团队内的沟通更为高效。微服务允许各个团队在这种高效的沟通模式下维护自己相对独立的服务单元。</p>
<p>正如我之前提到的，单体应用为什么不应该有模块化特性呢，这说不通，找不到任何理由。但是据大部分人有多年的经验来说，高度模块化的单体应用不过九牛一毛，因为大部分程序任然使用的是<a href="https://en.wikipedia.org/wiki/Big_ball_of_mud" target="_blank" rel="external">“大泥球”</a>这种架构模式。正式由于大部分单体应用最终都会存在这个问题，一些团队开始转向使用微服务架构。模块化之所以可以解耦是因为模块的边界化特性会阻碍模块之间的相互引用，但麻烦的是，对于单体应用系统，通常情况下会绕过这些阻碍。这样做可以帮助开发团队快速交付新功能，是一个高效可行的策略，但是如果大范围使用反而会破坏已有的模块化架构并降低开发团队的工作效率。把模块做成独立分开的微服务会使这种边界化优势更加显著，让那些问题更难出现。</p>
<p>数据持久层是耦合最突出的地方。去数据库中心化是微服务主要的特征之一，也就是说每一个微服务都可以有自己的数据库并自己管理，如果其他服务需要此数据库的数据时，不需要直接集成此数据库而是通过公共的API去获取，这就避免了不必要的<a href="http://martinfowler.com/bliki/IntegrationDatabase.html" target="_blank" rel="external">数据库集成</a>和耦合，这也是大型系统最严重的耦合之处。</p>
<p>这里也需要强调一下，单体应用也可以定义好的模块边界，但是构建这样的单体应用开发团队需要严格的自制力和毅力。同样微服务也可能被开发成一个“大泥球”系统，但是相对情况下，这样做很难。以我所见，使用微服务能够更好的实现模块化。如果你对团队的自制力和毅力有信心，这种优势可能不太明显，但是当团队不断壮大后维持自制力和毅力就变得愈加困难了，那么为了实现模块化，微服务就变得不可或缺了。</p>
<p>如果你错误的定义了微服务的边界，这种优势可能就变成阻碍。这就是<a href="http://martinfowler.com/bliki/MonolithFirst.html" target="_blank" rel="external">先开发单体应用</a>策略的两个主要原因之一，也就是为什么那些更倾向于<a href="http://martinfowler.com/articles/dont-start-monolith.html" target="_blank" rel="external">提早做微服务</a>的人也必须再理解某个领域之后才能开始做。</p>
<p>然而对于微服务的注意事项还不止这些。只有在一段时间之后你才有可能去评判一个系统模块化程度的好与坏。只有在实践微服务数年之后我们才能够判断微服务是否能够带来更好的模块化特性。此外，早期的实践者或许更加明智，因为大部分能力一般的团队开发微服务之后和从中受益可能会有些延迟。尽管如此，我们也得接受能力一般的软对开发质量一般的软件，与其与顶尖的开发团队比较还不如与使用单体应用架构开发的结果相比——这是一种逆向思维的对比方式。</p>
<p>我现在说的这些都是从早期实践过这种架构的人那里听到的一些真实案例。他们的判断是越早关注模块化越有意义。</p>
<p>有个案例特别有趣。某个团队做了错误的选择了使用微服务架构，但是根据文章<a href="http://martinfowler.com/bliki/MicroservicePremium.html" target="_blank" rel="external">微服务代价</a>来说他们的系统还不够复杂。这个项目出现了问题必须挽救，所以大部分人又加入了此项目。这种情况下，微服务架构可以帮上忙，因为比起单体系统来说微服务可以更容易消化大部分开发人员而且可以把大团队平均分配到各个团队。最终，这个团队效率高于开发单体应用，使团队能够追赶进度。但是任然有负面的影响，比起开发单体应用来说，微服务会花费更多的时间开发同样的功能，但是微服务架构在后期也可以提高效率。</p>
<p>有个案例特别有趣。某个团队做了错误的选择了使用微服务架构，但是根据文章<a href="http://martinfowler.com/bliki/MicroservicePremium.html" target="_blank" rel="external">微服务代价</a>来说他们的系统还不够复杂。这个项目很快出现了问题需要及时修复，因此一部分新人加入了此项目。对于加新人来说，微服务架构模式可能会起些作用，因为比起单体应用系统来说微服务更容易消化新加入的开发人员，更好的把人员分配到不同的服务团队中。后来，这个团队的开发效率比使用单体应用架构预期的效率要高，使团队能够追赶进度。但是总的来说还是有些影响，使用微服务架构会比使用单体应用架构花费更多的人天，即使这样，微服务架构确实也提高了效率。</p>
<h3 id="分布式">分布式</h3><p>微服务使用分布式系统来提高模块化。但是分布式系统有个很大的缺点，这个缺点正是其“分布式”特性。一旦你选择了分布式架构，你就会面临很多复杂的问题。<a href="http://martinfowler.com/articles/distributed-objects-microservices.html" target="_blank" rel="external">但是我并不认为微服务社区有考虑到分布式对象所带来的额外成本</a>，但是这种复杂度确实存在。</p>
<p>第一个问题是性能。你不得不正视功能之间调用的性能最近成为了热点问题，但是远程调用速度很慢。如果你的服务调用多个远程服务，而且每一个服务又调用其他服务，所有的响应时间加起来会变成可怕的潜在隐患。</p>
<p>当然你可以通过某种方式缓解这个问题。首先你可以增加被调用服务的粒度，也就是说你只调用一些聚合服务就够了。但这会使编程模型变得复杂，你不得不考虑如何批量的处理服务之间的调用。这种方法只能达到这种地步，因为你至少得一个一个的调用这些聚合服务。</p>
<p>第二种缓解方式是使用异步。如果并行调用六个异步方法，调用速度决定于这六个异步调用中最慢的那个而不是六个异步调用时间总和。这种方式可以获得很大的性能改进，但是同时也会导致另外一个我们所知的问题。异步编程很难：难于实现，也难于调试。但是为了达到可以接受的性能指标我听说过的大部分微服务案例都使用了异步技术。</p>
<p>性能之后是可靠性。你期待正在执行的功能调用能够工作，但是远程方法调用任何时候都可能失败。如果有大量的微服务的话，失败的几率就更大。聪敏的开发人员早就意识到这一点并及早做<a href="http://martinfowler.com/articles/microservices.html#DesignForFailure" target="_blank" rel="external">故障设计</a>。庆幸的是异步调用的策略也同样可以提高故障处理的弹性。但是这并起不了太大作用，你任然需要做其他的工作来找出具体是哪一个远程调用失败了。</p>
<p>这只是<a href="http://www.infoq.com/cn/news/2009/06/fallacies-distributed-computing" target="_blank" rel="external">分布式计算的谬误</a>提到的前两点。</p>
<p>对于这个问题有一些说明。首先，大部分问题都是随着单体应用不断扩大而导致。某些单体应用都是相对独立的，通常情况下，大部分工作在遗留系统之上。通过网络远程的方式与这些系统交互同样会遇到这些问题。这就是为什么大多数人倾向于更早的使用微服务架构来处理各网络服务之间的信息交付。这种时候经验就很有帮助了，一个有此经验的团队就能更好的解决这些分布式的问题。</p>
<p>但是分布式始终会是个成本问题。每次谈论分布式问题我都有点勉强，因为大多数人在使用分布式机构之前低估了它带来的问题。</p>
<h3 id="最终一致性">最终一致性</h3><p>我确认你也会认同访问网站需要一些耐心。你更新某些东西，如果你重新加载页面，想要更新的数据就丢失了。也许等几分钟之后，再次重新加载页面，更新的内容又出现了。</p>
<p>这种实用性很差的问题令人讨厌，这就是关系到最终一致性问题。你的更新操作可能被粉色节点处理，但是你的请求可能被绿色节点处理。直到绿色节点从粉色节点获取更新的结果，你陷入了不一致的情况。最总内容会达成一致，但是在这个过程中你会好奇是不是什么地方出了问题。</p>
<p>微服务由于具有其去数据中心化的特点，使用它就会造成最终一致性问题。对于单体应用来说，你可以在一个事务期间做多件事。而微服务需要更新多个不同的资源，分布式事务是很讨厌的(合理)。开发人员需要重视一致性问题，为了避免后悔，在做任何编码之间，试图搞清楚如何找出哪些过程是不同步的。</p>
<p>单体应用同样具有这些问题。在系统不断变大后，需要更多的做缓存来提高性能，但是缓存失效又是<a href="http://martinfowler.com/bliki/TwoHardThings.html" target="_blank" rel="external">另外一个问题</a>。大多数应用程序都需要<a href="http://martinfowler.com/eaaCatalog/optimisticOfflineLock.html" target="_blank" rel="external">离线锁</a>以避免长时间存在的数据库事务。外部系统需要更新但是又不能拥有事务处理。业务流程的不一致性问题没有你想的那么严重，因为业务通常考虑到了这点(业务流程本身就先理解分布式系统<a href="http://ksat.me/a-plain-english-introduction-to-cap-theorem/" target="_blank" rel="external">CAP原理</a>)。</p>
<p>如其他分布式系统问题一样，单体应用也没办法完全避免不一致的问题，但是这种问题要少得多，尤其是单体应用够小的话。</p>
<h3 id="独立部署">独立部署</h3><p>模块边界话和分布式系统的权衡困扰了我整个职业生涯。但是有一件事明显改变，在过去十年里，存在专门负责发布到产品环境的职位。在二十世纪，产品环境发布任然是偶尔而且最痛苦的过程，通常白天黑夜两班倒只是为了把软件放到某个地方可以工作。但是如今，成熟的团队可以频繁的部署的产品环境，许多组织开始实践<a href="http://martinfowler.com/bliki/ContinuousDelivery.html" target="_blank" rel="external">持续交付</a>，使得他们可以一天多次发布到产品环境。</p>
<p>这种改变对整个环境产业具有重大的意义，同样它也深远的影响着微服务。引入微服务就是为了解决部署大型单体应用的复杂度，即便是修改单体应用很小的一部分也可能导致整个部署失败。微服务的一个主要原则就是<a href="http://martinfowler.com/articles/microservices.html#ComponentizationViaServices" target="_blank" rel="external">服务即组件</a>，它们可以独立的部署。也就是说当你修改某个服务时，你只需要测试然后部署这个服务就够了。即便你搞砸了这个服务，也不会使整个系统崩溃。毕竟，由于需要故障设计，即使你的某个组件完全失败掉也不应当使系统的其他部分停止工作。</p>
<p>这是一种双向选择的关系。由于大部分微服务需要频繁的部署，所以你也许要同时兼顾部署。这就是为什么快速应用部署和快速基础设施创建是<a href="http://martinfowler.com/bliki/MicroservicePrerequisites.html" target="_blank" rel="external">微服务的前提</a>。比起这些基础的要求只要，你需要的是做持续交付。</p>
<p>持续交付最大的好处就是减少从想法到产品环境可运行的软件的周期时间。公司组织能够快速反应市场变化，比起他们的竞争对手开发新功能更加快速。</p>
<p>因为使用微服务所以大部分人开始使用持续交付，有必要提一下甚至大型单体应用也可以做持续交付。Facebook和Etsy就是两个最好的例子。也有很多尝试独立部署微服务失败的例子，多个微服务之间需要协调依次发布。但是我也听不少人说微服务做持续交付更为简单，但是我并不是很相信这跟模块化有太多的关系——尽管模块化确实与交付速度直接相关。</p>
<h3 id="运维复杂性">运维复杂性</h3><p>能够快速的部署独立的单元是件好事，但是同时也带来额外的维护难题，半打的应用程序可能变成了上百的微服务，很多公司组织很难找到合适的工具可以处理这种问题。</p>
<p>持续交付的角色就更加突出。对于单体应用来说持续交付是个很有价值的技术，值得尝试去使用它，它也逐渐变成微服务必备的技能。如果在没有自动化和持续交付的能力的话是没有办法处理那么多的服务的。维护复杂性就会随着管理和监控需求的增加而变大。如果微服务同时存在于单体应用程序之中的话，持续交付的成熟度模型就变得有用了。</p>
<p>微服务支持者认为由于每一个微服务都足够小，所以很容易理解。但是危险的是这并不能避免复杂度，它仅仅在不同服务之间转移而已。这就表现为增加运维复杂性，例如在服务之间调试非常困难。好的服务边界可以缓解这个问题，但是错误的服务边界就会使问题变得更糟。</p>
<p>处理这种维护复杂性需要许多新的技能和工具——技能更为重要。现有的工具还不成熟，而且我的本能告诉我即便有好的工具，技能的缺失在微服务的环境里还是起不了多大作用。</p>
<p>然而更好的技能和工具并不是处理微服务带来的维护复杂性最难解决的事情。为了办到这一切你需要引入devops文化：让开发人员，维护人员或者团队中的任何人员加入软件的交付过程。如果你不提高技能和改变文化，你的单体应用可能只是进行缓慢，但是你的微服务蒋会遭受创伤止步不前。</p>
<h3 id="技术架构多样性">技术架构多样性</h3><p>由于每一个微服务都是独立的可部署单元，你可以为你的服务选择任意合适的技术栈。微服务可以使用不同的语言，不同的框架甚至不同数据存储介质。允许团队选择合适的工具，针对不同的问题选择合适的语言或框架。</p>
<p>技术多向性的讨论集中体现为具体的事情找合适的工具，但是通常微服务最大的好处是版本控制更为乏味的问题。在单体应用中一个库字需要一个版本，通常导致升级问题。系统的一部可鞥需要升级某部分新功能但是同时可能破坏系统其他部分已有的功能。处理库版本控制的问题会随着代码库的变大而成指数级放大。</p>
<p>技术多样性是很危险的，它会使开发团队感到恐慌。我知道的大多数开发团队仅推荐使用一小部分核心的技术。这是由于大部分工具比如监控工具限制了你可以需用的技术。</p>
<p>不要低估实验的价值。对于单体应用系统，早期敲定的语言和框架很难改动。十年之后这些决定可能让团队困在这些拙劣的技术之内无法自拔。微服务允许团队尝试新的工具，并且每次迁移一个服务也算是比较先进的技术了。</p>
<h3 id="次要因素">次要因素</h3><p>上面列出的只是我能想到的一些主要的利与弊。下面也有些我认为不是很重要的因数。</p>
<p>微服务支持者常说微服务更容易做伸缩性扩展，你可以为你的微服务分配任意需要的负载，而单体应用就不行了。然而这让我想起了过去的经历，实际上有选择性的性能缩放比使用千篇一律的缩放要好得多。</p>
<p>微服务允许你分离一些敏感信息并且还可以在此之上加更多的安全保护。甚至你可以加强微服务之间的安全通信，这样就更难攻破。由于安全问题日益重要，考虑到这一点迁移到微服务是不二之选。即使不这样做，大部分单体应用系统也会创建分离的服务来处理一下敏感信息。</p>
<p>微服务的批判者认为比起单体应用微服务更难于测试。确实很难测试，算是分布式系统复杂性之一——这里介绍一些<a href="http://martinfowler.com/articles/microservice-testing/" target="_blank" rel="external">测试微服务的好方法</a>。对于测试单体应用和微服务的区别来说，更重要的是有自律性的去严肃对待测试。</p>
<h3 id="总结">总结</h3><p>关于任何架构风格的任何文章都有其局限性，正如我在文章<a href="http://martinfowler.com/bliki/LimitationsOfGeneralAdvice.html" target="_blank" rel="external">建议的局限性</a>所述。所以读此文章并不能帮助你做任何决定，但是这种文章能够启发你在决定是多考虑一些在文章里提到的因数。每一个提到的优缺点对不同的系统可能有不同的作用，有时候甚至优缺点颠倒(高度的模块边界化可能对复杂的大系统有用，但是对一般的小系统则有害无益)，做任何决定都应该基于特定的应用场景。考量哪一个因素才是对你的系统影响最大。此外，我们对微服务架构的经验也相对较少。你只有在系统趋于成熟的时候才能评判架构的正确性，只有在系统开发数年之后才会知道什么样的架构才有用。关于微服务架构，我们还没有多少实际的例子。</p>
<p>单体应用和微服务并不是一个简单的二元选择。它们都是相对比较模糊的概念，这就意味着大部分系统都会处于某个模糊的领域边界内。也有些系统都不属于这两种类型。大部分人，也包括我在内，在讨论微服务时总是拿单体应用作对比，因为对比更为普遍使用的系统更为有意义，但我们必须记住有一些系统式不属于我们提到的这两种类型的。我想单体应用和微服务算是软件架构中最主要的两种。它们都值得被提起，因为它们的有趣特点是很值得讨论的，但是并没有架构师严格的区分它们。</p>
<p>尽管这么说，一个概括性总结<a href="http://martinfowler.com/bliki/MicroservicePremium.html" target="_blank" rel="external">微服务代价</a>算是被大家广泛接受：微服务会增加复杂的大系统的生产效率。如果你可以控制单体应用系统的复杂度，你就不应当使用微服务。</p>
<p>但是这些关于微服务的言论并不应该让我们忘记什么才是印象软件项目成功与失败重要的因素。一些软性的因素诸如团队中的人员水平，人员之间的沟通效率，与领域专家的高效沟通，都会对项目有影响，并不决定你是否使用微服务。从技术的角度来说，更多的关注一些诸如整洁代码，好的测试和架构的演进。</p>
<h5 id="脚注">脚注</h5><ol>
<li><p>一些人认为“单体应用”是一个贬义词，意味着缺乏模块化结构设计的系统。在微服务的领域里大部分人不会这样做，他们把“单体应用”定义为把整个应用程序开发成一个独立的单元。微服务的支持者普遍认为大多数的单体应用最后都会变成大泥球，但是我不知道会不会有人对构建一个结构化的单体应用是不可能的有异议。</p>
</li>
<li><p>根据<a href="http://martinfowler.com/articles/microservices.html#ComponentizationViaServices" target="_blank" rel="external">微服务的定义</a>微服务可以独立的部署。那也就是说一部分服务必须有自己的部署顺序是反微服务架构的。</p>
</li>
</ol>
<h5 id="延伸阅读">延伸阅读</h5><p>Sam Newman在他的书<a href="http://www.amazon.cn/Building-Microservices-Newman-Sam/dp/1491950358/ref=sr_1_fkmr1_1?ie=UTF8&amp;qid=1436514928&amp;sr=8-1-fkmr1&amp;keywords=build+a+microservice" target="_blank" rel="external">构建微服务</a>第一章里面介绍了更多微服务的优点。</p>
<p>Benjamin Wootton的博客，<a href="http://highscalability.com/blog/2014/4/8/microservices-not-a-free-lunch.html" target="_blank" rel="external">微服务-不是免费的午餐</a>最早也是最好的总结了使用微服务的缺点。</p>
<h5 id="鸣谢">鸣谢</h5><p>Brian Mason, Chris Ford, Rebecca Parsons, Rob Miles, Scott Robinson, Stefan Tilkov, Steven Lowe, and Unmesh Joshi参与讨论和修改。</p>
<hr>
<p>翻译自<a href="http://martinfowler.com/articles/microservice-trade-offs.html" target="_blank" rel="external">Microservice Trade-Offs</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<p><img src="/img/microservice.png" alt="微服务架构"></p>
<p>现在许多开发团队已经意识到<a href="http://martinfowler.com/articles/microservices.html">微服务架构模式</a>会是解决大型单体应用架构所带来的问题的首选解决方案，但是某些团队也反应微服务架构会在某种程度上降低整个开发团队的开发效率。与任何其他架构模式一样，微服务架构也有其利弊之处，结合你特定的应用场景理解这些利弊之处能够帮助你做出更加明智的选择。</p>
<h4 id="微服务提供的好处…">微服务提供的好处…</h4><ul>
<li><a href="./#高度的模块边界化">高度的模块边界化</a>：微服务促进系统模块化，对大型团队尤其重要。</li>
<li><a href="./#独立部署">独立部署</a>：简单的服务部署更为容易因为它的依赖更少，并且服务是相对独立的，而且当某个服务出错时不太可能引起整个应用程序系统崩溃。</li>
<li><a href="./#技术多样性">技术多样性</a>：使用微服务你可以混用多种开发语言，开发框架和数据存储技术。</li>
</ul>
<h4 id="微服务引入的成本…">微服务引入的成本…</h4><ul>
<li><a href="./#分布式">分布式</a>：分布式系统开发难度大，因为远程调用速度慢且出错风险极高。</li>
<li><a href="./#最终一致性">最终一致性</a>：在分布式系统中管理强一致性问题更加困难，这意味着每个服务都必须关注系统的最终一致性问题。</li>
<li><a href="./#运维复杂性">运维复杂性</a>：你需要一个较为成熟的维护团队来管理诸多的微服务，处理日常的微服务更新及频繁部署等问题。</li>
</ul>]]>
    
    </summary>
    
      <category term="Martin Fowler" scheme="http://wenhao.github.io/tags/Martin-Fowler/"/>
    
      <category term="微服务" scheme="http://wenhao.github.io/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"/>
    
      <category term="翻译" scheme="http://wenhao.github.io/categories/%E7%BF%BB%E8%AF%91/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[互联网+]]></title>
    <link href="http://wenhao.github.io/2015/06/09/%E4%BA%92%E8%81%94%E7%BD%91/"/>
    <id>http://wenhao.github.io/2015/06/09/互联网/</id>
    <published>2015-06-09T01:13:41.000Z</published>
    <updated>2015-07-06T04:29:53.000Z</updated>
    <content type="html"><![CDATA[<p><img src="/img/互联网+.jpg" alt="互联网+"></p>
<p>&emsp;&emsp;眼下，互联网+持续升温，发展迅猛，加之政府大力扶持，中国经济开始进入技术、模式和产业大变革时期。在“站在这个风口上，猪都能飞起来了”的大背景之下，涌现出了一大批勇于创业积极创新的先进集体和个人。</p>
<h3 id="宏观政策">宏观政策</h3><p>&emsp;&emsp;当下，经济下行压力巨大，消费、投资和出口已不再是保持中国经济增长可靠的引擎。中国迫切的需要一个新的政策来拉动经济，促进消费及解决日益严峻的就业压力；加之地产行业的持续低迷，资产加速逃离，大量闲置资金急迫需要寻找下一个可靠的“资金池”以缓解经济运行压力。 “大众创业、万众创新”作为经济增长的双引擎之首写入政府工作报告， 以一种”抛开杂念，放手一搏“的精神激励着广大人民勇于创业积极创新的势头，可见政府抓重点调整产业结构的决心。互联网+恰好在各行各业起到了催化剂的作用，必将加速重塑传统行业的进程。</p>
<a id="more"></a>
<h3 id="趋势">趋势</h3><ul>
<li>连接需求方和供给方，去中心化。带来的是提高效率并充分利用资源，减少中间的分销流程，提供更为个性化的服务。例子：Uber、途家等。</li>
<li>传统行业互联网化，众多的细分行业都可以通过互联网获得发展机会。例如：B2C、C2C等。</li>
<li>对接互联网金融，一切的产业都需要金融的支持。例如：支付宝、陆金所P2P等。</li>
<li>智能时代，各种智能设备必将掀起新一轮的产业革命。例如：智能电视、智能家居、智能汽车、医疗健康、智能玩具、机器人等领域。</li>
</ul>
<h3 id="实践">实践</h3><h5 id="互联网+政府服务：">互联网+政府服务：</h5><p>&emsp;&emsp;资源整合，从基础设施服务(驾照违法查询、车辆年检预约、结婚登记预约、全程路况、水、电、煤气等)入手，对接政府各机构数据，打造一体化的城市服务平台。在不久的将来，也许不会再有类似“抄电表”之类的“土豪”工作，但是同样也会间接地衍生出很多需要特定专业技能的就业机会。</p>
<h5 id="互联网+传统农业：">互联网+传统农业：</h5><p>&emsp;&emsp;提高农村土地使用率，促进现代化农业进程，减少中间环节，细分市场，精准营销。例如：天天果园。</p>
<h5 id="互联网+教育：">互联网+教育：</h5><p>&emsp;&emsp;在线教育已不是什么新鲜的名词，而针对教育产业的“细分市场”提供更为”个性化“的授课体验也许会成为另一个朝阳产业。例如作业帮和学霸君等。</p>
<h5 id="互联网+医疗：">互联网+医疗：</h5><p>&emsp;&emsp;以往由于信息不对称导致药品价格虚高的现象将不复存在，药品电商会逐步取代传统的药品销售模式。各种可穿戴设备可以进一步提升医疗效率，避免医疗资源浪费。也许”医药代表“这一类”高大上“职业会慢慢退出历史的舞台。</p>
<p>更多……</p>
<h3 id="事件">事件</h3><ul>
<li>2014年8月29日，经国务院同意，发改委、工信部、科技部、公安部、财政部、国土部、住建部、交通部等八部委印发《关于促进智慧城市健康发展的指导意见》，要求各地区、各有关部门落实本指导意见提出的各项任务，确保智慧城市建设健康有序推进。</li>
<li>2014年9月10日，李克强提出，要在960万平方公里土地上掀起“大众创业”“草根创业”的新浪潮，形成“万众创新”“人人创新”的新态势。</li>
<li>2015年3月5日，在十二届全国人大三次会议上，李克强总理在政府工作报告中首次提出“互联网＋”行动计划。</li>
<li>2015年4月22日，蚂蚁金融服务集团、阿里巴巴集团与新浪微博，共同启动“互联网+城市服务”战略，联合为各地政府提供“智慧城市”的一站式解决方案。</li>
<li>2015年5月18日，暴风科技完成了第36个涨停，股价收报于248.6元，总市值达到298.32亿元，这接近迅雷市值（7.29亿美元）的6倍和优酷土豆38亿美元的市值。</li>
<li>2015年5月25日，四川省人民政府与腾讯公司在成都签署战略合作协议，就“互联网+”达成全面深层合作。</li>
</ul>
<h3 id="最后">最后</h3><p>&emsp;&emsp;以”互联网+痛点“为出发点可以衍生出很多新的创业创新的机会。产业和模式的创新需要依托技术的创新及支持，作为具备“创新”基因的TWers若能给站在“风口”上的创业者们提供专业的软件服务何尝不是另一种新的“互联网+软件服务”的革命呢?</p>
]]></content>
    <summary type="html">
    <![CDATA[<p><img src="/img/互联网+.jpg" alt="互联网+"></p>
<p>&emsp;&emsp;眼下，互联网+持续升温，发展迅猛，加之政府大力扶持，中国经济开始进入技术、模式和产业大变革时期。在“站在这个风口上，猪都能飞起来了”的大背景之下，涌现出了一大批勇于创业积极创新的先进集体和个人。</p>
<h3 id="宏观政策">宏观政策</h3><p>&emsp;&emsp;当下，经济下行压力巨大，消费、投资和出口已不再是保持中国经济增长可靠的引擎。中国迫切的需要一个新的政策来拉动经济，促进消费及解决日益严峻的就业压力；加之地产行业的持续低迷，资产加速逃离，大量闲置资金急迫需要寻找下一个可靠的“资金池”以缓解经济运行压力。 “大众创业、万众创新”作为经济增长的双引擎之首写入政府工作报告， 以一种”抛开杂念，放手一搏“的精神激励着广大人民勇于创业积极创新的势头，可见政府抓重点调整产业结构的决心。互联网+恰好在各行各业起到了催化剂的作用，必将加速重塑传统行业的进程。</p>]]>
    
    </summary>
    
      <category term="互联网+" scheme="http://wenhao.github.io/tags/%E4%BA%92%E8%81%94%E7%BD%91/"/>
    
      <category term="互联网+" scheme="http://wenhao.github.io/categories/%E4%BA%92%E8%81%94%E7%BD%91/"/>
    
  </entry>
  
</feed>